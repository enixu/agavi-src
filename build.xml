<?xml version="1.0"?>

<project name="agavi" basedir="." default="main">

  <!-- fileset for -dist files -->
  <fileset dir="." id="distfiles">
		<include name="**/*-dist"/>
  </fileset>

  <!-- main target -->
	<target name="main" description="main target">
		<echo msg="available targets: " /> 
		<echo msg="  project    - create a project" />
		<echo msg="  module     - create a module" />
		<echo msg="  action     - create an action" />
	</target>

	<!-- test target -->
	<target name="test" description="run unit tests">
		<phpunit2>
			<formatter type="xml" todir="reports"/>
			<batchtest>
				<fileset dir="tests">
					<include name="**/*Test*.php"/>
					<exclude name="**/sandbox/**"/>
				</fileset>
			</batchtest>
		</phpunit2>
		<phpunit2report infile="reports/testsuites.xml" format="frames" todir="reports/tests" styledir="etc"/>
		<echo msg="PHPUnit2 test reports have been built in reports/tests."/>
	</target>

	<target name="project" description="create a new project">
		<input propertyname="project.dir" promptChar="?" message="Full path to your new project (no trailing slash!)"/>
		<mkdir dir="${project.dir}"/>
		<mkdir dir="${project.dir}/www"/>
		<copy file="code_templates/index.php.tmpl" tofile="${project.dir}/www/index.php">
			<filterchain>
				<replacetokens begintoken="%%" endtoken="%%">    
					<token key="PATH_TO_AGAVI" value="${project.basedir}"/>
					<token key="PATH_TO_PROJECT" value="${project.dir}/webapp"/>
				</replacetokens>
			</filterchain>
		</copy>
		<mkdir dir="${project.dir}/www/modpub"/>
		<mkdir dir="${project.dir}/webapp"/>
		<mkdir dir="${project.dir}/webapp/cache"/>
		<copy file="code_templates/config.php.tmpl" tofile="${project.dir}/webapp/config.php">
			<filterchain>
				<replacetokens begintoken="%%" endtoken="%%">    
					<token key="PATH_TO_AGAVI" value="${project.basedir}"/>
					<token key="PATH_TO_PROJECT" value="${project.dir}/webapp"/>
				</replacetokens>
			</filterchain>
		</copy>
		<mkdir dir="${project.dir}/webapp/config"/>
		<copy todir="${project.dir}/webapp/config">
			<fileset dir="code_templates/config">
				<include name="*.ini"/>
				<include name="*.conf"/>
			</fileset>
		</copy>
		<mkdir dir="${project.dir}/webapp/lib"/>
		<mkdir dir="${project.dir}/webapp/lib/models"/>
		<mkdir dir="${project.dir}/webapp/modules"/>
		<mkdir dir="${project.dir}/webapp/templates"/>
		<input propertyname="modules" promptChar="?" defaultValue="Default" message="Modules for your project (no whitespace, comma seperated)"/>
		<foreach list="${modules}" param="module" target="buildmodule">
			<property name="project.dir" value="${project.dir}/webapp" override="true"/>
		</foreach>
	</target>

	<target name="module" description="create a new module">
		<available file="${project.dir}/modules" type="dir" property="is_webapp" value="true"/>
		<fail unless="is_webapp" message="Must be called in the root of a webapp directory."/>
		<input propertyname="module" promptChar="?" message="Module Name"/>
		<phingcall target="buildmodule"/>
	</target>

	<target name="buildmodule">
		<property name="prefix" value="${project.dir}/modules/${module}/"/>
		<mkdir dir="${prefix}"/>
		<mkdir dir="${prefix}actions"/>
		<mkdir dir="${prefix}config"/>
		<copy file="code_templates/module.ini.tmpl" tofile="${prefix}config/module.ini">
			<filterchain>
				<replacetokens begintoken="%%" endtoken="%%">    
					<token key="MODULE" value="${module}"/>
				</replacetokens>
			</filterchain>
		</copy>
		<mkdir dir="${prefix}models"/>
		<mkdir dir="${prefix}templates"/>
		<mkdir dir="${prefix}views"/>
		<input propertyname="actions" promptChar="?" defaultValue="Index" message="Actions for ${module} (no whitespace, comma seperated)"/>
		<foreach list="${actions}" param="action" target="buildaction"/>
		<input propertyname="models" promptChar="?" message="Models for ${module} (no whitespace, comma seperated)"/>
		<foreach list="${models}" param="model" target="buildmodel"/>
	</target>

	<target name="action" description="create a new action">
		<available file="${project.dir}/config/module.ini" property="is_module" value="true"/>
		<fail unless="is_module" message="Must be called in the root of a module directory."/>
		<property name="module" value="${cwd_name}"/>
		<input propertyname="action" promptChar="?" defaultValue="Index" message="Action Name"/>
		<property name="prefix" value="${project.dir}/"/>
		<phingcall target="buildaction"/>
	</target>

	<target name="buildaction">
		<copy file="code_templates/Action.class.php.tmpl" tofile="${prefix}actions/${action}Action.class.php">
			<filterchain>
				<replacetokens begintoken="%%" endtoken="%%">    
					<token key="MODULE" value="${module}"/>
					<token key="ACTION" value="${action}"/>
				</replacetokens>
			</filterchain>
		</copy>
		<input propertyname="views" promptChar="?" defaultValue="Success" message="Views for ${action} (no whitespace, comma seperated)"/>
		<foreach list="${views}" param="view" target="buildview"/>
	</target>

	<target name="buildview">
		<copy file="code_templates/View.class.php.tmpl" tofile="${prefix}views/${action}${view}View.class.php">
			<filterchain>
				<replacetokens begintoken="%%" endtoken="%%">    
					<token key="MODULE" value="${module}"/>
					<token key="ACTION" value="${action}"/>
					<token key="VIEW" value="${view}"/>
				</replacetokens>
			</filterchain>
		</copy>
		<touch file="${prefix}templates/${action}${view}.php"/>
	</target>

	<target name="model" description="create a new model">
		<input propertyname="model" promptChar="?" defaultValue="${module}" message="Model Name"/>
		<property name="prefix" value="${project.dir}/"/>
		<phingcall target="buildmodel"/>
	</target>

	<target name="buildmodel">
		<copy file="code_templates/Model.class.php.tmpl" tofile="${prefix}models/${model}Model.class.php">
			<filterchain>
				<replacetokens begintoken="%%" endtoken="%%">    
					<token key="MODULE" value="${module}"/>
					<token key="MODEL" value="${model}"/>
				</replacetokens>
			</filterchain>
		</copy>
	</target>

</project>
